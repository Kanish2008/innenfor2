<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Logistikk Portal - Innenfor</title>
  <style>
    :root{
      --green:#3f5a4f;
      --green-dark:#2f463d;
      --cream:#f5f3ee;
      --card:#ffffff;
      --accent:#d97b61;
      --text:#3f5a4f;
      --text-light:#6b7f75;
    }
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body{
      background:#f9f7f4;
      color:var(--text);
    }
    .logistics-container{
      max-width:1400px;
      margin:0 auto;
      padding:40px 20px;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:40px;
      background:#fff;
      padding:20px 30px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
    }
    .header h1{
      font-size:28px;
      color:var(--green-dark);
    }
    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:20px;
      margin-bottom:30px;
    }
    .stat-card{
      background:#fff;
      padding:20px;
      border-radius:12px;
      text-align:center;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
    }
    .stat-value{
      font-size:28px;
      font-weight:700;
      color:var(--accent);
      margin-bottom:5px;
    }
    .stat-label{
      font-size:12px;
      color:var(--text-light);
      text-transform:uppercase;
    }
    .table-container{
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
      overflow-x:auto;
      margin-bottom:30px;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    thead{
      background:#f5f3ee;
      border-bottom:2px solid #e8e4df;
    }
    th{
      padding:15px;
      text-align:left;
      font-weight:600;
      color:var(--text);
    }
    td{
      padding:15px;
      border-bottom:1px solid #e8e4df;
    }
    td.holiday-cell{
      text-align:center;
      vertical-align:middle;
    }
    tbody tr:hover{
      background:#f9f7f4;
    }
    .holiday-tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 14px;
      border-radius:12px;
      background:#f5f3ee;
      border:1px solid #e8e4df;
      font-weight:700;
      color:var(--green-dark);
      text-transform:uppercase;
      letter-spacing:0.4px;
      white-space:nowrap;
    }
    .status-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
    }
    .status-planlagt{
      background:#fce8e3;
      color:var(--accent);
    }
    .status-pakket{
      background:#e8f0ed;
      color:var(--green);
    }
    .status-sendt{
      background:#cce5e0;
      color:var(--green-dark);
    }
    .status-levert{
      background:#a8d5ca;
      color:#fff;
    }
    .btn{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
      transition:background .3s;
    }
    .btn:hover{
      background:#c56a52;
    }
    .btn-green{
      background:var(--green-dark);
    }
    .btn-green:hover{
      background:var(--green);
    }
    .modal{
      display:none;
      position:fixed;
      z-index:1000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
    }
    .modal.show{
      display:flex;
    }
    .modal-content{
      background:#fff;
      border-radius:12px;
      padding:30px;
      max-width:600px;
      width:90%;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-close{
      position:absolute;
      right:20px;
      top:20px;
      font-size:28px;
      cursor:pointer;
      color:#999;
    }
    .form-group{
      margin-bottom:15px;
    }
    .form-group label{
      display:block;
      margin-bottom:5px;
      font-weight:500;
      color:var(--text);
    }
    .form-group input,
    .form-group select,
    .form-group textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:14px;
      font-family:inherit;
    }
    .logout-btn{
      padding:10px 20px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
    }
    .filter-bar{
      display:flex;
      gap:15px;
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    .filter-bar select{
      padding:8px 12px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:14px;
    }
  </style>
</head>
<body>

<div class="logistics-container">
  <div class="header">
    <h1>Logistikk Partner Portal</h1>
    <button class="logout-btn" onclick="logout()">Logg ut</button>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="totalOrders">0</div>
      <div class="stat-label">Totale ordrer</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="pendingOrders">0</div>
      <div class="stat-label">Ventende</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="deliveredOrders">0</div>
      <div class="stat-label">Levert</div>
    </div>
  </div>

  <div class="table-container">
    <h2 style="color: var(--green-dark); margin-bottom: 20px;">Mine ordrer</h2>
    
    <div class="filter-bar">
      <select onchange="filterByStatus(this.value)">
        <option value="">Alle statuser</option>
        <option value="planlagt">Planlagt</option>
        <option value="pakket">Pakket</option>
        <option value="sendt">Sendt</option>
        <option value="levert">Levert</option>
      </select>
      <select onchange="filterByDate(this.value)">
        <option value="">Alle datoer</option>
        <option value="today">I dag</option>
        <option value="week">Denne uken</option>
        <option value="month">Denne m√•neden</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Ordre ID</th>
          <th>Mottaker</th>
          <th>Adresse</th>
          <th>H√∏ytid</th>
          <th>Status</th>
          <th>Leveringsdato</th>
          <th>Handling</th>
        </tr>
      </thead>
      <tbody id="ordersTable">
        <tr>
          <td colspan="7" style="text-align: center; padding: 30px; color: var(--text-light);">
            Ingen ordrer forel√∏pig
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- UPDATE ORDER MODAL -->
<div id="updateModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeUpdateModal()">&times;</span>
    <h2 style="color: var(--green-dark); margin-bottom: 20px;">Oppdater ordrestatus</h2>
    
    <form onsubmit="handleStatusUpdate(event)">
      <div class="form-group">
        <label>Ny status</label>
        <select id="newStatus" required>
          <option value="">Velg status</option>
          <option value="planlagt">Planlagt</option>
          <option value="pakket">Pakket</option>
          <option value="sendt">Sendt</option>
          <option value="levert">Levert</option>
        </select>
      </div>

      <div class="form-group">
        <label>Tracking nummer</label>
        <input type="text" id="trackingNumber" placeholder="F.eks. TRACK12345">
      </div>

      <div class="form-group">
        <label>Notat</label>
        <textarea id="orderNote" placeholder="Legg til notat om leveringen..." style="min-height: 100px;"></textarea>
      </div>

      <div class="form-group">
        <label>Last opp leveringsbevis (bilde)</label>
        <input type="file" id="deliveryProof" accept="image/*">
      </div>

      <button type="submit" class="btn btn-green" style="width: 100%; padding: 12px; font-size: 16px;">Lagre oppdatering</button>
    </form>
  </div>
</div>

<script>
  // Universal storage wrapper for cross-platform compatibility
  const AppStorage = {
    setItem(key, value) {
      try { localStorage.setItem(key, value); } catch (e) { console.warn('Storage unavailable'); }
    },
    getItem(key) {
      try { return localStorage.getItem(key); } catch (e) { return null; }
    },
    removeItem(key) {
      try { localStorage.removeItem(key); } catch (e) { }
    }
  };

  let currentUser = null;
  let selectedOrderId = null;
  let allOrders = [];

  document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    loadOrders();
  });

  function checkAuth() {
    // For demo purposes, allow logistics partner access
    const user = JSON.parse(AppStorage.getItem('innenfor_currentUser'));
    if (!user) {
      // Create demo logistics user
      const demoUser = {
        id: 'logistics-1',
        name: 'Logistikk Partner AS',
        email: 'logistics@partner.no',
        type: 'logistics'
      };
      AppStorage.setItem('innenfor_currentUser', JSON.stringify(demoUser));
      currentUser = demoUser;
    } else {
      currentUser = user;
    }
  }

  function loadOrders() {
    // Load orders from all sources (admin created, b2b, b2c)
    const b2bOrders = JSON.parse(AppStorage.getItem('innenfor_orders') || '[]');
    const b2cOrders = JSON.parse(AppStorage.getItem('b2c_orders') || '[]');
    
    allOrders = [
      ...b2bOrders.map(o => ({...o, source: 'B2B'})),
      ...b2cOrders.map(o => ({...o, source: 'B2C'}))
    ];

    updateStats();
    displayOrders(allOrders);
  }

  function updateStats() {
    document.getElementById('totalOrders').textContent = allOrders.length;
    document.getElementById('pendingOrders').textContent = allOrders.filter(o => o.status !== 'levert').length;
    document.getElementById('deliveredOrders').textContent = allOrders.filter(o => o.status === 'levert').length;
  }

  function displayOrders(orders) {
    const tbody = document.getElementById('ordersTable');
    
    if (orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: var(--text-light);">Ingen ordrer</td></tr>';
      return;
    }

    tbody.innerHTML = orders.map(order => `
      <tr>
        <td>${order.id}</td>
        <td>${order.recipientName || 'Ukjent'}</td>
        <td>${order.recipientAddress || 'Ikke oppgitt'}</td>
        <td class="holiday-cell"><span class="holiday-tag">${getHolidayLabel(order.holiday)}</span></td>
        <td><span class="status-badge status-${order.status || 'planlagt'}">${order.status || 'Planlagt'}</span></td>
        <td>${new Date(order.date).toLocaleDateString('no-NO')}</td>
        <td><button class="btn" onclick="openUpdateModal('${order.id}')">Oppdater</button></td>
      </tr>
    `).join('');
  }

  function getHolidayLabel(name = '') {
    const key = (name || '').toLowerCase();
    if (key.includes('eid')) return 'üåô Eid al-Fitr';
    if (key.includes('jul')) return 'üéÑ Jul';
    if (key.includes('diwali')) return 'ü™î Diwali';
    if (key.includes('han')) return 'üïé Hanukkah';
    if (key.includes('nowruz') || key.includes('norooz')) return 'üå∏ Nowruz';
    if (key.includes('p√•s') || key.includes('paas')) return 'üê£ P√•ske';
    return name || 'H√∏ytid';
  }

  function openUpdateModal(orderId) {
    selectedOrderId = orderId;
    document.getElementById('updateModal').classList.add('show');
  }

  function closeUpdateModal() {
    document.getElementById('updateModal').classList.remove('show');
    selectedOrderId = null;
  }

  function handleStatusUpdate(event) {
    event.preventDefault();
    
    const newStatus = document.getElementById('newStatus').value;
    const tracking = document.getElementById('trackingNumber').value;
    const note = document.getElementById('orderNote').value;

    // Update the order
    const order = allOrders.find(o => o.id === selectedOrderId);
    if (order) {
      order.status = newStatus;
      order.tracking = tracking;
      order.notes = note;
      order.updatedAt = new Date().toISOString();
    }

    alert(`Order ${selectedOrderId} updated to ${newStatus}!`);
    closeUpdateModal();
    loadOrders();
  }

  function filterByStatus(status) {
    if (!status) {
      displayOrders(allOrders);
      return;
    }
    displayOrders(allOrders.filter(o => (o.status || 'planlagt') === status));
  }

  function filterByDate(period) {
    if (!period) {
      displayOrders(allOrders);
      return;
    }

    const today = new Date();
    let filtered = [];

    if (period === 'today') {
      filtered = allOrders.filter(o => {
        const orderDate = new Date(o.date);
        return orderDate.toDateString() === today.toDateString();
      });
    } else if (period === 'week') {
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      filtered = allOrders.filter(o => new Date(o.date) >= weekAgo);
    } else if (period === 'month') {
      const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      filtered = allOrders.filter(o => new Date(o.date) >= monthAgo);
    }

    displayOrders(filtered);
  }

  function logout() {
    AppStorage.removeItem('innenfor_currentUser');
    window.location.href = 'index.html';
  }
</script>

</body>
</html>
