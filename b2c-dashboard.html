<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Min portal - Innenfor</title>
  <style>
    :root{
      --green:#3f5a4f;
      --green-dark:#2f463d;
      --cream:#f5f3ee;
      --card:#ffffff;
      --accent:#d97b61;
      --text:#3f5a4f;
      --text-light:#6b7f75;
    }
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body{
      background:#f9f7f4;
      color:var(--text);
    }
    .b2c-container{
      max-width:1200px;
      margin:0 auto;
      padding:40px 20px;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:40px;
      background:#fff;
      padding:20px 30px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
    }
    .header h1{
      font-size:28px;
      color:var(--green-dark);
    }
    .logout-btn{
      padding:10px 20px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
    }
    .delete-btn{
      padding:10px 20px;
      background:#dc3545;
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      margin-right:10px;
    }
    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:30px;
      border-bottom:2px solid #e8e4df;
    }
    .tab{
      padding:15px 20px;
      cursor:pointer;
      border:none;
      background:transparent;
      color:var(--text-light);
      font-size:16px;
      border-bottom:3px solid transparent;
      transition:.3s;
    }
    .tab.active{
      color:var(--accent);
      border-bottom-color:var(--accent);
    }
    .content{
      display:none;
    }
    .content.active{
      display:block;
    }
    .section-title{
      font-size:24px;
      color:var(--green-dark);
      margin-bottom:20px;
      font-weight:600;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px;
      margin-bottom:30px;
    }
    .card{
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
    }
    .card h3{
      color:var(--green-dark);
      margin-bottom:10px;
    }
    .card p{
      color:var(--text-light);
      font-size:14px;
      margin-bottom:15px;
    }
    .card .thumb{
      width:100%;
      height:160px;
      object-fit:cover;
      border-radius:10px;
      margin-bottom:12px;
      display:block;
    }
    .thumb-banner{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:700;
      font-size:20px;
      color:#fff;
      background:#f5f3ee;
      border:1px solid #e8e4df;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-blend-mode:multiply;
      text-shadow:0 2px 8px rgba(0,0,0,0.35);
      letter-spacing:0.5px;
      text-transform:uppercase;
      text-align:center;
    }
    .thumb-icon{
      font-size:42px;
      line-height:1;
    }
    .thumb-eid{background-image:linear-gradient(160deg,rgba(0,0,0,0.25),rgba(0,0,0,0.45)),url('assets/eid.jpg');}
    .thumb-jul{background-image:linear-gradient(160deg,rgba(0,0,0,0.25),rgba(0,0,0,0.45)),url('assets/jul.webp');}
    .thumb-diwali{background-image:linear-gradient(160deg,rgba(0,0,0,0.25),rgba(0,0,0,0.45)),url('assets/diwali.webp');}
    .thumb-hanukkah{background-image:linear-gradient(160deg,rgba(0,0,0,0.25),rgba(0,0,0,0.45)),url('assets/hanukkah.jpg');}
    .thumb-nowruz{background-image:linear-gradient(160deg,rgba(0,0,0,0.25),rgba(0,0,0,0.45)),url('assets/nowruz.jpg');}
    .thumb-paaske{background-image:linear-gradient(160deg,rgba(0,0,0,0.25),rgba(0,0,0,0.45)),url('assets/p√•ske.jpg');}
    }
    .btn{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:10px 20px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      transition:background .3s;
    }
    .btn:hover{
      background:#c56a52;
    }
    .btn-green{
      background:#e05c3b;
    }
    .btn-green:hover{
      background:#c84f33;
    }
    .order-table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
    }
    .order-table th{
      background:#f5f3ee;
      padding:15px;
      text-align:left;
      font-weight:600;
      color:var(--text);
      border-bottom:2px solid #e8e4df;
    }
    .order-table td{
      padding:15px;
      border-bottom:1px solid #e8e4df;
    }
    .order-table tr:hover{
      background:#f9f7f4;
    }
    .status-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
      background:#a8d5ca;
      color:#fff;
    }
    .modal{
      display:none;
      position:fixed;
      z-index:1000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
    }
    .modal.show{
      display:flex;
    }
    .modal-content{
      background:#fff;
      border-radius:12px;
      padding:30px;
      max-width:500px;
      width:90%;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-close{
      position:absolute;
      right:20px;
      top:20px;
      font-size:28px;
      cursor:pointer;
      color:#999;
    }
    .form-group{
      margin-bottom:15px;
    }
    .form-group label{
      display:block;
      margin-bottom:5px;
      font-weight:500;
      color:var(--text);
    }
    .form-group input,
    .form-group select,
    .form-group textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:14px;
      font-family:inherit;
    }
    .rating{
      display:flex;
      gap:5px;
      margin:10px 0;
    }
    .star{
      font-size:24px;
      cursor:pointer;
      opacity:.3;
      transition:opacity .2s;
    }
    .star:hover,
    .star.active{
      opacity:1;
    }
  </style>
</head>
<body>

<div class="b2c-container">
  <div class="header">
    <h1>‚ô• Min portal</h1>
    <div>
      <span id="currentUser" style="color: var(--green-dark); margin-right: 20px; font-weight: 600;"></span>
      <button class="delete-btn" onclick="deleteMyAccount()">Slett min konto</button>
      <button class="logout-btn" onclick="logout()">Logg ut</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('bestill')">Bestill gave</button>
    <button class="tab" onclick="switchTab('historikk')">Min historikk</button>
    <button class="tab" onclick="switchTab('sporing')">Sporing</button>
    <button class="tab" onclick="switchTab('vurderinger')">Vurderinger</button>
  </div>

  <!-- BESTILL GAVE -->
  <div id="bestill" class="content active">
    <h2 class="section-title">Bestill en gave</h2>
    
    <div class="grid">
      <div class="card">
        <div class="thumb thumb-banner thumb-eid"><span class="thumb-icon">üåô</span><span>Eid al-Fitr</span></div>
        <h3>Eid al-Fitr</h3>
        <p>Islam - Fastebrekk festival</p>
        <p style="font-size: 16px; color: var(--green-dark); font-weight: 600; margin-bottom: 15px;">Fra 199 kr</p>
        <button class="btn btn-green" onclick="openOrderModal('Eid al-Fitr')">Bestill</button>
      </div>
      
      <div class="card">
        <div class="thumb thumb-banner thumb-jul"><span class="thumb-icon">üéÑ</span><span>Jul</span></div>
        <h3>Jul</h3>
        <p>Kristendom - Julen</p>
        <p style="font-size: 16px; color: var(--green-dark); font-weight: 600; margin-bottom: 15px;">Fra 199 kr</p>
        <button class="btn btn-green" onclick="openOrderModal('Jul')">Bestill</button>
      </div>
      
      <div class="card">
        <div class="thumb thumb-banner thumb-diwali"><span class="thumb-icon">ü™î</span><span>Diwali</span></div>
        <h3>Diwali</h3>
        <p>Hinduisme - Lysfestivalen</p>
        <p style="font-size: 16px; color: var(--green-dark); font-weight: 600; margin-bottom: 15px;">Fra 199 kr</p>
        <button class="btn btn-green" onclick="openOrderModal('Diwali')">Bestill</button>
      </div>

      <div class="card">
        <div class="thumb thumb-banner thumb-hanukkah"><span class="thumb-icon">üïé</span><span>Hanukkah</span></div>
        <h3>Hanukkah</h3>
        <p>J√∏dedom - Hanukka</p>
        <p style="font-size: 16px; color: var(--green-dark); font-weight: 600; margin-bottom: 15px;">Fra 199 kr</p>
        <button class="btn btn-green" onclick="openOrderModal('Hanukkah')">Bestill</button>
      </div>

      <div class="card">
        <div class="thumb thumb-banner thumb-nowruz"><span class="thumb-icon">üå∏</span><span>Nowruz</span></div>
        <h3>Nowruz</h3>
        <p>Persisk - Nytt√•rsfeiring</p>
        <p style="font-size: 16px; color: var(--green-dark); font-weight: 600; margin-bottom: 15px;">Fra 199 kr</p>
        <button class="btn btn-green" onclick="openOrderModal('Nowruz')">Bestill</button>
      </div>

      <div class="card">
        <div class="thumb thumb-banner thumb-paaske"><span class="thumb-icon">üê£</span><span>P√•ske</span></div>
        <h3>P√•ske</h3>
        <p>Kristendom - P√•sken</p>
        <p style="font-size: 16px; color: var(--green-dark); font-weight: 600; margin-bottom: 15px;">Fra 199 kr</p>
        <button class="btn btn-green" onclick="openOrderModal('P√•ske')">Bestill</button>
      </div>
    </div>
  </div>

  <!-- MIN HISTORIKK -->
  <div id="historikk" class="content">
    <h2 class="section-title">Min ordrehistorikk</h2>
    <table class="order-table">
      <thead>
        <tr>
          <th>Ordre ID</th>
          <th>H√∏ytid</th>
          <th>Mottaker</th>
          <th>Status</th>
          <th>Dato</th>
        </tr>
      </thead>
      <tbody id="historikkTable">
        <tr>
          <td colspan="5" style="text-align: center; color: var(--text-light);">Ingen ordrer enn√•</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- SPORING -->
  <div id="sporing" class="content">
    <h2 class="section-title">Leveringssporing</h2>
    <div id="sporingContent">
      <p style="color: var(--text-light); text-align: center; padding: 40px;">
        Du har ingen aktive leveringer for √∏yeblikket
      </p>
    </div>
  </div>

  <!-- VURDERINGER -->
  <div id="vurderinger" class="content">
    <h2 class="section-title">Gi vurdering</h2>
    <div class="grid">
      <div class="card">
        <h3>Hvordan var opplevelsen?</h3>
        <p style="margin-bottom: 20px;">Vi ville gjerne h√∏re fra deg om den levert gaven oppfylte dine forventninger.</p>
        
        <form onsubmit="handleFeedback(event)">
          <div class="form-group">
            <label>Ordre ID</label>
            <input type="text" placeholder="F.eks. 123456" required>
          </div>
          
          <div class="form-group">
            <label>Rangering</label>
            <div class="rating" id="ratingStars">
              <span class="star" onclick="rate(1)">‚òÖ</span>
              <span class="star" onclick="rate(2)">‚òÖ</span>
              <span class="star" onclick="rate(3)">‚òÖ</span>
              <span class="star" onclick="rate(4)">‚òÖ</span>
              <span class="star" onclick="rate(5)">‚òÖ</span>
            </div>
            <input type="hidden" id="ratingValue" value="0">
          </div>
          
          <div class="form-group">
            <label>Kommentar (valgfritt)</label>
            <textarea placeholder="Del dine tanker..." style="min-height: 100px;"></textarea>
          </div>
          
          <button type="submit" class="btn btn-green" style="width: 100%;">Send vurdering</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ORDER MODAL -->
<div id="orderModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeOrderModal()">&times;</span>
    <h2 style="color: var(--green-dark); margin-bottom: 20px;">Bestill gave</h2>
    
    <form onsubmit="handleOrder(event)">
      <div class="form-group">
        <label>Mottakers navn</label>
        <input type="text" required>
      </div>
      
      <div class="form-group">
        <label>Mottakers adresse</label>
        <input type="text" required>
      </div>
      
      <div class="form-group">
        <label>Mottakers e-post</label>
        <input type="email" required>
      </div>
      
      <div class="form-group">
        <label>Personlig melding</label>
        <textarea placeholder="Skriv en varm hilsen..." style="min-height: 80px;"></textarea>
      </div>
      
      <div class="form-group">
        <label>Leveringsdato</label>
        <input type="date" required>
      </div>
      
      <button type="submit" class="btn btn-green" style="width: 100%; padding: 12px; font-size: 16px;">Bekreft bestilling</button>
    </form>
  </div>
</div>

<script>
  // Universal storage wrapper for cross-platform compatibility
  const AppStorage = {
    setItem(key, value) {
      try { localStorage.setItem(key, value); } catch (e) { console.warn('Storage unavailable'); }
    },
    getItem(key) {
      try { return localStorage.getItem(key); } catch (e) { return null; }
    },
    removeItem(key) {
      try { localStorage.removeItem(key); } catch (e) { }
    }
  };

  let currentUser = null;
  let selectedHoliday = null;

  document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    loadData();
    loadCardImages();
  });

  function checkAuth() {
    const user = JSON.parse(AppStorage.getItem('innenfor_currentUser'));
    if (!user || user.type !== 'privatperson') {
      alert('Ikke autorisert. Du m√• v√¶re privatperson-bruker.');
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    document.getElementById('currentUser').textContent = `Hei, ${user.name}!`;
  }

  function loadData() {
    // Load orders history
    const orders = JSON.parse(AppStorage.getItem('b2c_orders') || '[]');
    const tbody = document.getElementById('historikkTable');
    
    if (orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-light); padding: 20px;">Ingen ordrer enn√•</td></tr>';
      return;
    }
    
    tbody.innerHTML = orders.map(order => `
      <tr>
        <td>${order.id}</td>
        <td>${order.holiday}</td>
        <td>${order.recipientName}</td>
        <td><span class="status-badge">${order.status}</span></td>
        <td>${new Date(order.date).toLocaleDateString('no-NO')}</td>
      </tr>
    `).join('');
  }

  function switchTab(tabName) {
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
  }

  function openOrderModal(holiday) {
    selectedHoliday = holiday;
    document.getElementById('orderModal').classList.add('show');
  }

  function closeOrderModal() {
    document.getElementById('orderModal').classList.remove('show');
  }

  function handleOrder(event) {
    event.preventDefault();
    
    const order = {
      id: 'ORD-' + Date.now().toString().slice(-6),
      holiday: selectedHoliday,
      recipientName: event.target[0].value,
      recipientAddress: event.target[1].value,
      recipientEmail: event.target[2].value,
      message: event.target[3].value,
      date: event.target[4].value,
      status: 'Planlagt',
      userId: currentUser.id,
      createdAt: new Date().toISOString()
    };
    
    // Lagre i b√•de b2c_orders (for historikk) og innenfor_orders (for admin)
    let b2cOrders = JSON.parse(AppStorage.getItem('b2c_orders') || '[]');
    b2cOrders.push(order);
    AppStorage.setItem('b2c_orders', JSON.stringify(b2cOrders));
    
    let allOrders = JSON.parse(AppStorage.getItem('innenfor_orders') || '[]');
    allOrders.push({...order, source: 'B2C'});
    AppStorage.setItem('innenfor_orders', JSON.stringify(allOrders));
    
    alert('Orden bekreftet! Tracking ID: ' + order.id);
    closeOrderModal();
    loadData();
  }

  function rate(rating) {
    document.getElementById('ratingValue').value = rating;
    const stars = document.querySelectorAll('#ratingStars .star');
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add('active');
      } else {
        star.classList.remove('active');
      }
    });
  }

  function handleFeedback(event) {
    event.preventDefault();
    const rating = document.getElementById('ratingValue').value;
    if (rating === '0') {
      alert('Vennligst velg en rangering');
      return;
    }
    alert('Takk for vurderingen din!');
    event.target.reset();
  }

  function deleteMyAccount() {
    if (!confirm('Er du sikker p√• at du vil slette kontoen din permanent? All din data vil bli fjernet og dette kan ikke angres.')) {
      return;
    }
    
    if (!confirm('Siste sjanse! Er du helt sikker? Denne handlingen kan IKKE angres.')) {
      return;
    }
    
    const email = currentUser.email;
    const userId = currentUser.id;
    
    // Remove user from users list
    let users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    users = users.filter(u => u.email !== email);
    AppStorage.setItem('innenfor_users', JSON.stringify(users));
    
    // Remove all user's orders
    let b2cOrders = JSON.parse(AppStorage.getItem('b2c_orders') || '[]');
    b2cOrders = b2cOrders.filter(o => o.userId !== userId);
    AppStorage.setItem('b2c_orders', JSON.stringify(b2cOrders));
    
    // Remove current user session
    AppStorage.removeItem('innenfor_currentUser');
    
    alert('Din konto og all data er permanent slettet. Du blir n√• logget ut.');
    window.location.href = 'index.html';
  }

  function logout() {
    AppStorage.removeItem('innenfor_currentUser');
    window.location.href = 'index.html';
  }

  // Dynamisk bilde-laster: pr√∏ver flere filnavn og endelser
  function loadCardImages() {
    const extOrder = ['webp','png','jpg','jpeg','WEBP','PNG','JPG','JPEG','svg','SVG'];
    const nameMap = {
      eid: ['eid'],
      jul: ['jul'],
      diwali: ['diwali'],
      hanukkah: ['hanukkah'],
      nowruz: ['nowruz'],
      // Support both with/without diacritics
      paaske: ['p√•ske','paaske']
    };
    Object.keys(nameMap).forEach(key => {
      const img = document.querySelector(`img.thumb[data-key="${key}"]`);
      if (!img) return;
      const candidates = [];
      nameMap[key].forEach(base => {
        extOrder.forEach(ext => candidates.push(`assets/${base}.${ext}`));
      });
      tryNext(0);
      function tryNext(i){
        if (i >= candidates.length) { console.debug('[Innenfor] No image found for', key); return; }
        const test = new Image();
        test.onload = () => { img.src = candidates[i]; console.debug('[Innenfor] Loaded image for', key, '‚Üí', candidates[i]); };
        test.onerror = () => tryNext(i+1);
        // encode spaces safely
        test.src = encodeURI(candidates[i]);
      }
    });
  }
</script>

</body>
</html>
