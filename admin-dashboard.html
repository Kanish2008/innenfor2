<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Innenfor</title>
  <style>
    :root{
      --green:#3f5a4f;
      --green-dark:#2f463d;
      --cream:#f5f3ee;
      --card:#ffffff;
      --accent:#d97b61;
      --text:#3f5a4f;
      --text-light:#6b7f75;
    }
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body{
      background:#f9f7f4;
      color:var(--text);
    }
    .admin-container{
      display:grid;
      grid-template-columns:250px 1fr;
      min-height:100vh;
    }
    /* SIDEBAR */
    .sidebar{
      background:var(--green-dark);
      color:#fff;
      padding:30px 20px;
      overflow-y:auto;
    }
    .sidebar-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:40px;
      font-size:20px;
      font-weight:700;
    }
    .sidebar-menu{
      list-style:none;
    }
    .sidebar-menu li{
      margin-bottom:15px;
    }
    .sidebar-menu a{
      color:#fff;
      text-decoration:none;
      padding:10px 15px;
      display:block;
      border-radius:8px;
      cursor:pointer;
      transition:background .3s;
    }
    .sidebar-menu a:hover,
    .sidebar-menu a.active{
      background:var(--green);
    }
    .logout-btn{
      margin-top:40px;
      padding:12px 15px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      width:100%;
      transition:background .3s;
    }
    .logout-btn:hover{
      background:#c56a52;
    }
    /* MAIN CONTENT */
    .main-content{
      padding:30px;
      overflow-y:auto;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:30px;
    }
    .header h1{
      font-size:28px;
      color:var(--green-dark);
    }
    .user-info{
      display:flex;
      align-items:center;
      gap:15px;
    }
    /* SECTIONS */
    .section{
      display:none;
    }
    .section.active{
      display:block;
    }
    .dashboard-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:20px;
      margin-bottom:30px;
    }
    .metric-card{
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
    }
    .metric-card h3{
      font-size:14px;
      color:var(--text-light);
      margin-bottom:10px;
    }
    .metric-value{
      font-size:32px;
      font-weight:700;
      color:var(--green-dark);
    }
    /* TABLES */
    .table-container{
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
      overflow-x:auto;
      margin-bottom:20px;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    thead{
      background:#f5f3ee;
      border-bottom:2px solid #e8e4df;
    }
    th{
      padding:12px;
      text-align:left;
      font-weight:600;
      color:var(--text);
    }
    td{
      padding:12px;
      border-bottom:1px solid #e8e4df;
    }
    tbody tr:hover{
      background:#f9f7f4;
    }
    .status-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
    }
    .status-planlagt{
      background:#fce8e3;
      color:var(--accent);
    }
    .status-pakket{
      background:#e8f0ed;
      color:var(--green);
    }
    .status-sendt{
      background:#cce5e0;
      color:var(--green-dark);
    }
    .status-levert{
      background:#a8d5ca;
      color:#fff;
    }
    /* FORMS */
    .form-group{
      margin-bottom:15px;
    }
    .form-group label{
      display:block;
      margin-bottom:5px;
      font-weight:500;
      color:var(--text);
    }
    .form-group input,
    .form-group select,
    .form-group textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:14px;
      font-family:inherit;
    }
    .form-group textarea{
      resize:vertical;
      min-height:100px;
    }
    .btn{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:10px 20px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      transition:background .3s;
    }
    .btn:hover{
      background:#c56a52;
    }
    .btn-green{
      background:var(--green-dark);
    }
    .btn-green:hover{
      background:var(--green);
    }
    /* MESSAGING */
    .messages-container{
      display:grid;
      grid-template-columns:350px 1fr;
      gap:20px;
      height:600px;
    }
    .message-list{
      background:#fff;
      border-radius:12px;
      overflow-y:auto;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
    }
    .message-item{
      padding:15px;
      border-bottom:1px solid #e8e4df;
      cursor:pointer;
      transition:background .2s;
    }
    .message-item:hover,
    .message-item.active{
      background:#f9f7f4;
    }
    .message-item strong{
      display:block;
      color:var(--text);
    }
    .message-item small{
      color:var(--text-light);
      font-size:12px;
    }
    .message-thread{
      background:#fff;
      border-radius:12px;
      display:flex;
      flex-direction:column;
      box-shadow:0 4px 20px rgba(0,0,0,.06);
    }
    .message-thread-header{
      padding:15px;
      border-bottom:1px solid #e8e4df;
      font-weight:600;
    }
    .message-thread-body{
      flex:1;
      overflow-y:auto;
      padding:15px;
    }
    .message{
      margin-bottom:15px;
      padding:10px 15px;
      border-radius:8px;
      max-width:80%;
    }
    .message.admin{
      background:var(--green-dark);
      color:#fff;
      margin-left:auto;
    }
    .message.user{
      background:#e8e4df;
      color:var(--text);
    }
    .message-thread-footer{
      padding:15px;
      border-top:1px solid #e8e4df;
      display:flex;
      gap:10px;
    }
    .message-thread-footer input{
      flex:1;
    }
    .modal{
      display:none;
      position:fixed;
      z-index:1000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
    }
    .modal.show{
      display:flex;
    }
    .modal-content{
      background:#fff;
      border-radius:12px;
      padding:30px;
      max-width:600px;
      width:90%;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-close{
      position:absolute;
      right:20px;
      top:20px;
      font-size:28px;
      cursor:pointer;
      color:#999;
    }
    .live-notification{
      background:var(--accent);
      color:#fff;
      padding:15px;
      border-radius:8px;
      margin-bottom:20px;
      animation:slideIn .5s ease;
    }
    @keyframes slideIn{
      from{
        transform:translateY(-20px);
        opacity:0;
      }
      to{
        transform:translateY(0);
        opacity:1;
      }
    }
  </style>
</head>
<body>

<div class="admin-container">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">‚ô• Innenfor</div>
    <ul class="sidebar-menu">
      <li><a href="#" onclick="switchSection('dashboard')" class="menu-item active">Dashboard</a></li>
      <li><a href="#" onclick="switchSection('users')" class="menu-item">Brukere</a></li>
      <li><a href="#" onclick="switchSection('orders')" class="menu-item">Ordrer</a></li>
      <li><a href="#" onclick="switchSection('gdpr')" class="menu-item">GDPR-svar</a></li>
      <li><a href="#" onclick="switchSection('logistics')" class="menu-item">Logistikk</a></li>
      <li><a href="#" onclick="switchSection('messages')" class="menu-item">Meldinger</a></li>
      <li><a href="#" onclick="switchSection('reports')" class="menu-item">Rapporter</a></li>
      <li><a href="#" onclick="switchSection('audit')" class="menu-item">Audit Logg</a></li>
    </ul>
    <button class="logout-btn" onclick="logout()">Logg ut</button>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <div class="header">
      <h1>Admin Dashboard</h1>
      <div class="user-info">
        <span id="currentUser"></span>
        <span style="font-size: 20px;">‚ô•</span>
      </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboard" class="section active">
      <div id="liveNotifications"></div>
      
      <h2 style="margin-bottom: 20px; color: var(--green-dark);">N√∏kkeltall</h2>
      <div class="dashboard-grid">
        <div class="metric-card">
          <h3>Totale brukere</h3>
          <div class="metric-value" id="totalUsers">0</div>
        </div>
        <div class="metric-card">
          <h3>Bedrifter</h3>
          <div class="metric-value" id="totalBedrifter">0</div>
        </div>
        <div class="metric-card">
          <h3>Privatpersoner</h3>
          <div class="metric-value" id="totalPrivatpersoner">0</div>
        </div>
        <div class="metric-card">
          <h3>Ordrer i dag</h3>
          <div class="metric-value" id="ordersToday">0</div>
        </div>
      </div>

      <h2 style="margin-bottom: 20px; margin-top: 30px; color: var(--green-dark);">Nye registreringer (Live)</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Navn</th>
              <th>E-post</th>
              <th>Brukertype</th>
              <th>Registrert</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="recentUsersTable">
          </tbody>
        </table>
      </div>
    </div>

    <!-- USERS SECTION -->
    <div id="users" class="section">
      <h2 style="margin-bottom: 20px; color: var(--green-dark);">Brukerh√•ndtering</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Navn</th>
              <th>E-post</th>
              <th>Type</th>
              <th>Status</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="usersTable">
          </tbody>
        </table>
      </div>
    </div>

    <!-- ORDERS SECTION -->
    <div id="orders" class="section">
      <h2 style="margin-bottom: 20px; color: var(--green-dark);">Ordreoversikt</h2>
      <button class="btn btn-green" onclick="openOrderModal()" style="margin-bottom: 20px;">+ Ny ordre</button>
      <div id="newOrdersNotification"></div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Bruker</th>
              <th>H√∏ytid</th>
              <th>Mottaker</th>
              <th>Status</th>
              <th>Leveringsdato</th>
              <th>Kilde</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
          </tbody>
        </table>
      </div>
    </div>

    <!-- LOGISTICS SECTION -->
    <div id="logistics" class="section">
      <h2 style="margin-bottom: 20px; color: var(--green-dark);">Logistikkoversikt</h2>
      <div style="display: grid; grid-template-columns: 200px 200px; gap: 15px; margin-bottom: 20px;">
        <div class="form-group">
          <label>Filter etter status</label>
          <select id="logisticsFilter" onchange="filterLogistics()">
            <option value="">Alle</option>
            <option value="planlagt">Planlagt</option>
            <option value="pakket">Pakket</option>
            <option value="sendt">Sendt</option>
            <option value="levert">Levert</option>
          </select>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Mottaker</th>
              <th>Status</th>
              <th>Leverand√∏r</th>
              <th>Tracking</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="logisticsTable">
          </tbody>
        </table>
      </div>
    </div>

    <!-- MESSAGES SECTION -->
    <div id="messages" class="section">
      <h2 style="margin-bottom: 20px; color: var(--green-dark);">Kundest√∏tte</h2>
      <div class="messages-container">
        <div class="message-list" id="messagesList">
        </div>
        <div class="message-thread">
          <div class="message-thread-header" id="messageThreadHeader">
            Velg en samtale
          </div>
          <div class="message-thread-body" id="messageThreadBody">
          </div>
          <div class="message-thread-footer" id="messageThreadFooter" style="display: none;">
            <input type="text" id="messageInput" placeholder="Skriv melding...">
            <button class="btn btn-green" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GDPR SECTION -->
    <div id="gdpr" class="section">
      <h2 style="margin-bottom: 20px; color: var(--green-dark);">GDPR Sp√∏rreskjema Svar</h2>
      <div id="gdprNotification" style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;"></div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Tidspunkt</th>
              <th>Type</th>
              <th>H√∏ytider per √•r</th>
              <th>Antall personer</th>
            </tr>
          </thead>
          <tbody id="gdprTable">
          </tbody>
        </table>
      </div>
    </div>

    <!-- REPORTS SECTION -->
    <div id="reports" class="section">
      <h2 style="margin-bottom: 20px; color: var(--green-dark);">Rapporter</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <button class="btn btn-green" onclick="generateReport('users')" style="padding: 20px; font-size: 16px;">
          üìä Brukeroversikt (PDF)
        </button>
        <button class="btn btn-green" onclick="generateReport('orders')" style="padding: 20px; font-size: 16px;">
          üì¶ Ordroversikt (CSV)
        </button>
        <button class="btn btn-green" onclick="generateReport('logistics')" style="padding: 20px; font-size: 16px;">
          üìç Logistikk (PDF)
        </button>
      </div>
    </div>

    <!-- AUDIT SECTION -->
    <div id="audit" class="section">
      <h2 style="margin-bottom: 20px; color: var(--green-dark);">Audit Logg</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Tidspunkt</th>
              <th>Bruker</th>
              <th>Handling</th>
              <th>Detaljer</th>
            </tr>
          </thead>
          <tbody id="auditTable">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ORDER MODAL -->
<div id="orderModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeOrderModal()">&times;</span>
    <h2>Opprett ny ordre</h2>
    <form onsubmit="handleCreateOrder(event)">
      <div class="form-group">
        <label>Bruker</label>
        <select id="orderUser" required>
          <option value="">Velg bruker</option>
        </select>
      </div>
      <div class="form-group">
        <label>H√∏ytid</label>
        <select id="orderHoliday" required>
          <option value="">Velg h√∏ytid</option>
          <option value="Eid al-Fitr">Eid al-Fitr</option>
          <option value="Jul">Jul</option>
          <option value="Diwali">Diwali</option>
          <option value="Hanukkah">Hanukkah</option>
          <option value="Nowruz">Nowruz</option>
          <option value="P√•ske">P√•ske</option>
        </select>
      </div>
      <div class="form-group">
        <label>Gave</label>
        <input type="text" id="orderGift" placeholder="Gave beskrivelse" required>
      </div>
      <div class="form-group">
        <label>Leveringsdato</label>
        <input type="date" id="orderDate" required>
      </div>
      <button type="submit" class="btn btn-green" style="width: 100%; padding: 12px;">Opprett ordre</button>
    </form>
  </div>
</div>

<script>
  // Universal storage wrapper for cross-platform compatibility
  const AppStorage = {
    setItem(key, value) {
      try { localStorage.setItem(key, value); } catch (e) { console.warn('Storage unavailable'); }
    },
    getItem(key) {
      try { return localStorage.getItem(key); } catch (e) { return null; }
    },
    removeItem(key) {
      try { localStorage.removeItem(key); } catch (e) { }
    }
  };

  let currentUser = null;
  let selectedMessageThread = null;
  let allOrders = [];
  let lastOrderCount = 0;
  let lastGDPRCount = 0;

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    loadData();
    updateDashboard();
    loadGDPRResponses();
    setInterval(checkNewOrders, 1000); // Check for new orders every 1 second
    setInterval(checkNewUsers, 2000); // Check for new users every 2 seconds
    setInterval(checkNewGDPRResponses, 1000); // Check for new GDPR responses every 1 second
  });

  function checkAuth() {
    const userStr = AppStorage.getItem('innenfor_currentUser');
    console.log('checkAuth - userStr:', userStr);
    
    if (!userStr) {
      alert('Ikke autorisert. Du m√• v√¶re administrator.');
      window.location.href = 'index.html';
      return;
    }
    
    const user = JSON.parse(userStr);
    console.log('checkAuth - user:', user);
    
    // Fallback: if admin email detected, enforce administrator type
    if (user && (user.email || '').toLowerCase() === 'adil@fairhire.no' && user.type !== 'administrator') {
      user.type = 'administrator';
      AppStorage.setItem('innenfor_currentUser', JSON.stringify(user));
    }
    
    if (!user || user.type !== 'administrator') {
      alert('Ikke autorisert. Du m√• v√¶re administrator.');
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    document.getElementById('currentUser').textContent = `${user.name} (Admin)`;
    logAction('Innlogging', `Admin ${user.name} logget inn`);
  }

  function loadData() {
    const users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    updateMetrics(users);
    populateUserTables(users);
    populateOrderSelects(users);
    loadMessages();
    loadAllOrders();
  }

  function loadAllOrders() {
    const b2bOrders = JSON.parse(AppStorage.getItem('innenfor_orders') || '[]');
    const b2cOrders = JSON.parse(AppStorage.getItem('b2c_orders') || '[]');
    
    allOrders = [
      ...b2bOrders.map(o => ({
        ...o,
        source: 'B2B',
        recipientName: o.recipientName || 'Ukjent'
      })),
      ...b2cOrders.map(o => ({
        ...o,
        source: 'B2C',
        holiday: o.holiday
      }))
    ];

    lastOrderCount = allOrders.length;
    displayOrders();
  }

  function displayOrders() {
    const tbody = document.getElementById('ordersTable');
    const users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    
    tbody.innerHTML = allOrders.map(order => {
      const user = users.find(u => u.id === order.userId);
      return `
        <tr>
          <td>${order.id}</td>
          <td>${user ? user.name : 'Ukjent'}</td>
          <td>${order.holiday}</td>
          <td>${order.recipientName || 'Ikke oppgitt'}</td>
          <td><span class="status-badge status-${order.status || 'planlagt'}">${order.status || 'Planlagt'}</span></td>
          <td>${new Date(order.date).toLocaleDateString('no-NO')}</td>
          <td>${order.source}</td>
          <td><button class="btn" onclick="viewOrder('${order.id}')">Se</button></td>
        </tr>
      `;
    }).join('');
  }

  function checkNewOrders() {
    const b2bOrders = JSON.parse(AppStorage.getItem('innenfor_orders') || '[]');
    const b2cOrders = JSON.parse(AppStorage.getItem('b2c_orders') || '[]');
    const totalOrders = b2bOrders.length + b2cOrders.length;
    
    if (totalOrders > lastOrderCount) {
      const newOrderCount = totalOrders - lastOrderCount;
      const users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
      
      // Find the newest order
      const allNewOrders = [
        ...b2bOrders.filter(o => !allOrders.find(ao => ao.id === o.id)),
        ...b2cOrders.filter(o => !allOrders.find(ao => ao.id === o.id))
      ];
      
      allNewOrders.forEach(order => {
        const user = users.find(u => u.id === order.userId);
        const source = b2bOrders.find(o => o.id === order.id) ? 'B2B' : 'B2C';
        showNotification(`Ny ordre fra ${user ? user.name : 'Ukjent'}: ${order.holiday}`);
        logAction('Ny ordre', `${order.id} - ${user ? user.name : 'Ukjent'} bestilte ${order.holiday}`);
      });
      
      loadAllOrders();
    }
  }

  function updateMetrics(users) {
    document.getElementById('totalUsers').textContent = users.length;
    document.getElementById('totalBedrifter').textContent = users.filter(u => u.type === 'bedrift').length;
    document.getElementById('totalPrivatpersoner').textContent = users.filter(u => u.type === 'privatperson').length;
  }

  function updateDashboard() {
    const users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    const tbody = document.getElementById('recentUsersTable');
    
    const recentUsers = users.slice(-10).reverse();
    tbody.innerHTML = recentUsers.map(user => `
      <tr>
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td>${user.type}</td>
        <td>${new Date(user.createdAt).toLocaleString('no-NO')}</td>
        <td><button class="btn" onclick="viewUser('${user.email}')">Se</button></td>
      </tr>
    `).join('');
  }

  function checkNewUsers() {
    const users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    const lastCheck = JSON.parse(AppStorage.getItem('lastUserCheck') || '{}');
    
    users.forEach(user => {
      if (!lastCheck[user.id]) {
        showNotification(`Ny bruker registrert: ${user.name} (${user.type})`);
        logAction('Ny registrering', `${user.name} registrert som ${user.type}`);
      }
    });
    
    AppStorage.setItem('lastUserCheck', JSON.stringify(users.reduce((acc, u) => ({...acc, [u.id]: true}), {})));
  }

  function showNotification(message) {
    const container = document.getElementById('liveNotifications');
    const notification = document.createElement('div');
    notification.className = 'live-notification';
    notification.textContent = `üîî ${message}`;
    container.prepend(notification);
    
    setTimeout(() => notification.remove(), 5000);
  }

  function populateUserTables(users) {
    const tbody = document.getElementById('usersTable');
    tbody.innerHTML = users.map(user => `
      <tr>
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td>${user.type}</td>
        <td><span class="status-badge" style="background: #e8f0ed; color: var(--green);">Aktiv</span></td>
        <td>
          <button class="btn" onclick="editUser('${user.email}')">Rediger</button>
          <button class="btn" style="background: #dc3545; margin-left: 8px;" onclick="deleteUser('${user.email}')">Slett</button>
        </td>
      </tr>
    `).join('');
  }

  function populateOrderSelects(users) {
    const select = document.getElementById('orderUser');
    select.innerHTML = '<option value="">Velg bruker</option>' + users.map(u => 
      `<option value="${u.id}">${u.name} (${u.email})</option>`
    ).join('');
  }

  function switchSection(sectionName) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionName).classList.add('active');
    
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    event.target.classList.add('active');
  }

  function openOrderModal() {
    document.getElementById('orderModal').classList.add('show');
  }

  function closeOrderModal() {
    document.getElementById('orderModal').classList.remove('show');
  }

  function handleCreateOrder(event) {
    event.preventDefault();
    const order = {
      id: Date.now().toString(),
      userId: document.getElementById('orderUser').value,
      holiday: document.getElementById('orderHoliday').value,
      gift: document.getElementById('orderGift').value,
      date: document.getElementById('orderDate').value,
      status: 'planlagt',
      createdAt: new Date().toISOString()
    };
    
    allOrders.push(order);
    AppStorage.setItem('innenfor_orders', JSON.stringify(allOrders));
    logAction('Ordre opprettet', `Ordre ${order.id} opprettet`);
    alert('Ordre opprettet!');
    closeOrderModal();
    location.reload();
  }

  function loadMessages() {
    const users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    const messagesList = document.getElementById('messagesList');
    
    messagesList.innerHTML = users.filter(u => u.type !== 'administrator').map(user => `
      <div class="message-item" onclick="openMessageThread('${user.id}')">
        <strong>${user.name}</strong>
        <small>${user.email}</small>
      </div>
    `).join('');
  }

  function openMessageThread(userId) {
    selectedMessageThread = userId;
    const users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    const user = users.find(u => u.id === userId);
    
    document.getElementById('messageThreadHeader').textContent = `Samtale med ${user.name}`;
    document.getElementById('messageThreadBody').innerHTML = `<p style="color: var(--text-light);">Ingen meldinger enn√•</p>`;
    document.getElementById('messageThreadFooter').style.display = 'flex';
    
    document.querySelectorAll('.message-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');
  }

  function sendMessage() {
    const input = document.getElementById('messageInput');
    if (!input.value.trim()) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message admin';
    messageDiv.textContent = input.value;
    
    document.getElementById('messageThreadBody').appendChild(messageDiv);
    input.value = '';
    logAction('Melding sendt', `Admin sendte melding til bruker`);
  }

  function generateReport(type) {
    const users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    let content = '';
    
    if (type === 'users') {
      content = `Brukeroversikt - ${new Date().toLocaleDateString('no-NO')}\n\n`;
      content += users.map(u => `Navn: ${u.name}\nE-post: ${u.email}\nType: ${u.type}\nRegistrert: ${new Date(u.createdAt).toLocaleDateString('no-NO')}\n\n`).join('');
    }
    
    // Simple CSV export for orders
    if (type === 'orders') {
      content = 'Order ID,Bruker,H√∏ytid,Status,Dato\n';
      allOrders.forEach(o => {
        const user = users.find(u => u.id === o.userId);
        content += `${o.id},${user ? user.name : 'Ukjent'},${o.holiday},${o.status},${o.date}\n`;
      });
    }
    
    downloadFile(content, `rapport-${type}.txt`);
    logAction('Rapport generert', `${type} rapport eksportert`);
  }

  function downloadFile(content, filename) {
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

  function logAction(action, details) {
    const logs = JSON.parse(AppStorage.getItem('innenfor_auditLog') || '[]');
    logs.push({
      timestamp: new Date().toISOString(),
      user: currentUser.name,
      action: action,
      details: details
    });
    AppStorage.setItem('innenfor_auditLog', JSON.stringify(logs));
    updateAuditTable();
  }

  function updateAuditTable() {
    const logs = JSON.parse(AppStorage.getItem('innenfor_auditLog') || '[]');
    const tbody = document.getElementById('auditTable');
    
    const recentLogs = logs.slice(-20).reverse();
    tbody.innerHTML = recentLogs.map(log => `
      <tr>
        <td>${new Date(log.timestamp).toLocaleString('no-NO')}</td>
        <td>${log.user}</td>
        <td>${log.action}</td>
        <td>${log.details}</td>
      </tr>
    `).join('');
  }

  function logout() {
    AppStorage.removeItem('innenfor_currentUser');
    logAction('Utlogging', 'Admin logget ut');
    window.location.href = 'index.html';
  }

  function filterLogistics() {
    // Placeholder for logistics filtering
  }

  function editUser(email) {
    alert('Rediger bruker: ' + email);
  }

  function deleteUser(email) {
    if (!confirm(`Er du sikker p√• at du vil slette brukeren med e-post ${email}? Dette kan ikke angres.`)) {
      return;
    }
    
    let users = JSON.parse(AppStorage.getItem('innenfor_users') || '[]');
    const userToDelete = users.find(u => u.email === email);
    
    if (!userToDelete) {
      alert('Bruker ikke funnet');
      return;
    }
    
    // Prevent deleting the admin user
    if (userToDelete.type === 'administrator') {
      alert('Kan ikke slette administrator-brukeren');
      return;
    }
    
    // Remove the user from all storage locations
    users = users.filter(u => u.email !== email);
    AppStorage.setItem('innenfor_users', JSON.stringify(users));
    
    // Also remove from current user if logged in as this user
    const currentUserStr = AppStorage.getItem('innenfor_currentUser');
    if (currentUserStr) {
      const currentUser = JSON.parse(currentUserStr);
      if (currentUser.email === email) {
        AppStorage.removeItem('innenfor_currentUser');
      }
    }
    
    // Remove user's orders from b2c_orders
    let b2cOrders = JSON.parse(AppStorage.getItem('b2c_orders') || '[]');
    b2cOrders = b2cOrders.filter(o => o.userId !== userToDelete.id);
    AppStorage.setItem('b2c_orders', JSON.stringify(b2cOrders));
    
    // Remove user's orders from innenfor_orders (b2b)
    let b2bOrders = JSON.parse(AppStorage.getItem('innenfor_orders') || '[]');
    b2bOrders = b2bOrders.filter(o => o.userId !== userToDelete.id);
    AppStorage.setItem('innenfor_orders', JSON.stringify(b2bOrders));
    
    // Remove user's employees if bedrift user
    if (userToDelete.type === 'bedrift') {
      let employees = JSON.parse(AppStorage.getItem('b2b_employees') || '[]');
      employees = employees.filter(e => e.companyId !== userToDelete.id);
      AppStorage.setItem('b2b_employees', JSON.stringify(employees));
    }
    
    logAction('Bruker slettet', `Bruker ${userToDelete.name} (${email}) og all tilh√∏rende data ble slettet`);
    alert(`Bruker ${userToDelete.name} og all tilh√∏rende data er slettet permanent fra alle systemer`);
    
    // Reload data
    loadData();
  }

  function viewUser(email) {
    alert('Se bruker: ' + email);
  }

  function viewOrder(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (order) {
      alert(`Ordre: ${orderId}\nH√∏ytid: ${order.holiday}\nMottaker: ${order.recipientName}\nStatus: ${order.status}\nDato: ${new Date(order.date).toLocaleDateString('no-NO')}`);
    }
  }

  function loadGDPRResponses() {
    const gdprSubmissions = JSON.parse(AppStorage.getItem('gdpr_submissions') || '[]');
    lastGDPRCount = gdprSubmissions.length;
    displayGDPRResponses(gdprSubmissions);
  }

  function displayGDPRResponses(gdprSubmissions) {
    const tbody = document.getElementById('gdprTable');
    
    tbody.innerHTML = gdprSubmissions.map(response => {
      const date = new Date(response.timestamp);
      return `
        <tr>
          <td>${date.toLocaleString('no-NO')}</td>
          <td>${response.type}</td>
          <td>${response.holidays}</td>
          <td>${response.persons}</td>
        </tr>
      `;
    }).reverse().join('');
  }

  function checkNewGDPRResponses() {
    const gdprSubmissions = JSON.parse(AppStorage.getItem('gdpr_submissions') || '[]');
    
    if (gdprSubmissions.length > lastGDPRCount) {
      const newResponseCount = gdprSubmissions.length - lastGDPRCount;
      showNotification(`${newResponseCount} nye GDPR-svar mottatt`);
      logAction('Nye GDPR-svar', `${newResponseCount} nye sp\u00f8rreskjema-svar mottatt`);
      loadGDPRResponses();
    }
  }

  // Load orders on startup
  window.addEventListener('load', function() {
    allOrders = JSON.parse(AppStorage.getItem('innenfor_orders') || '[]');
    updateAuditTable();
  });
</script>

</body>
</html>
